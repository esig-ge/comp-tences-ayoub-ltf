{% extends 'taches/base.html' %}

{% block title %}Ma Liste de Tâches{% endblock %}

{% block content %}

    {# 1. FORMULAIRE DE CRÉATION (Utilisation de TacheCreateView) #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Ajouter une nouvelle tâche</h5>
        </div>
        <div class="card-body">

            {# CORRECTION IMPORTANTE : L'action doit pointer vers l'URL de création #}
            {# Nous allons simplifier en pointant vers l'URL 'tache_create' si vous utilisez une vue séparée pour la création #}
            {# Si vous voulez la combiner, l'action doit pointer vers l'URL de la liste, mais l'utilisation de {{ form }} est cruciale. #}

            <form method="POST" action="{% url 'tache_create' %}">
                {% csrf_token %}

                <div class="input-group">

                    {# CORRECTION : Afficher le champ 'titre' du formulaire géré par TacheForm #}
                    {# Cette méthode est utilisée si vous n'avez QUE le champ titre dans le form. #}
                    {{ form.titre }}

                    <button type="submit" class="btn btn-success">Ajouter</button>
                </div>

                {# AFFICHER LES ERREURS S'IL Y EN A (pour le champ titre) #}
                {% if form.titre.errors %}
                    <div class="text-danger small mt-2">{{ form.titre.errors }}</div>
                {% endif %}
            </form>
        </div>
    </div>

    <hr class="my-4">

    <h1 class="mb-4 text-secondary">Tâches en attente</h1>

    {# 2. LISTE DES TÂCHES ET LIENS CRUD #}
    {% for tache in taches %}
        <div class="tache-item mb-3 d-flex justify-content-between align-items-center
             {% if tache.completee %}text-decoration-line-through text-muted completee{% endif %}">

            <div>
                {# L'ID de la tâche est la clé primaire (pk) pour les liens #}
                <h5 class="mb-1">{{ tache.titre }}</h5>
                {% if tache.description %}
                    <p class="mb-0 small text-dark">{{ tache.description }}</p>
                {% endif %}
                <small class="text-muted">Échéance : {{ tache.date_due|default:"N/A"|date:"d M Y" }}</small><br>
                <small class="text-muted">Créée le: {{ tache.date_creation|date:"d M, H:i" }}</small>
            </div>

            <div class="flex-shrink-0">

                {# LIEN MODIFIER (Update) #}
                <a href="{% url 'tache_update' pk=tache.pk %}" class="btn btn-sm btn-outline-info">Modifier</a>

                {# LIEN SUPPRIMER (Delete) #}
                <a href="{% url 'tache_delete' pk=tache.pk %}" class="btn btn-sm btn-outline-danger">Supprimer</a>

                {% if not tache.completee %}
                    {# LIEN TERMINER (Nous devons ajouter une URL spécifique pour marquer comme complète) #}
                    <a href="{% url 'tache_toggle_complete' pk=tache.pk %}" class="btn btn-sm btn-success">Terminer</a>
                {% else %}
                    <span class="badge bg-success">Terminée</span>
                {% endif %}
            </div>

        </div>
    {% empty %}
        <p class="alert alert-info text-center">Aucune tâche trouvée pour le moment !</p>
    {% endfor %}
{% endblock content %}